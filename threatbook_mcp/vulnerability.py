"""å¾®æ­¥åœ¨çº¿å¨èƒåˆ†ææ¼æ´æƒ…æŠ¥æ¨¡å—"""

import logging
from typing import Any, Dict, List
import mcp.types as types
from threatbook_mcp.response_handler import ThreatBookResponseHandler

logger = logging.getLogger("threatbook-mcp.vulnerability")


class VulnerabilityTool:
    """æ¼æ´æƒ…æŠ¥å·¥å…·"""
    
    def __init__(self, client):
        self.client = client
    
    def get_tool_definition(self) -> types.Tool:
        """è·å–å·¥å…·å®šä¹‰"""
        return types.Tool(
            name="vulnerability",
            description="æ¼æ´æƒ…æŠ¥ï¼šè·å–å…¬å¼€æ¼æ´çš„åŸºç¡€ä¿¡æ¯ã€é£é™©è¯„ä¼°ã€PoCã€å¤„ç½®å»ºè®®ã€è¡¥ä¸ç­‰ä¿¡æ¯",
            inputSchema={
                "type": "object",
                "properties": {
                    "vuln_id": {
                        "type": "string",
                        "description": "æ¼æ´ç¼–å·ï¼Œæ”¯æŒXVEã€CVEã€CNVDã€CNNVDæˆ–NVDBç¼–å·ï¼Œæ”¯æŒæ‰¹é‡æŸ¥è¯¢ï¼ˆé€—å·åˆ†éš”ï¼Œæœ€å¤š100ä¸ªï¼‰"
                    },
                    "vendor": {
                        "type": "string",
                        "description": "æ¼æ´å½±å“å‚å•†ï¼Œç²¾ç¡®æŸ¥è¯¢"
                    },
                    "product": {
                        "type": "string",
                        "description": "æ¼æ´å½±å“äº§å“ï¼Œæ”¯æŒæ‰¹é‡æŸ¥è¯¢ï¼ˆé€—å·åˆ†éš”ï¼Œæœ€å¤š100ä¸ªï¼‰"
                    },
                    "component_name": {
                        "type": "string",
                        "description": "æ¼æ´å½±å“ç»„ä»¶"
                    },
                    "update_time": {
                        "type": "string",
                        "description": "æŒ‰æ›´æ–°æ—¶é—´ç­›é€‰ï¼š30d/7d/3d/1d",
                        "enum": ["30d", "7d", "3d", "1d"]
                    },
                    "is_highrisk": {
                        "type": "boolean",
                        "description": "æ˜¯å¦åªè¿”å›é«˜é£é™©æ¼æ´"
                    },
                    "limit": {
                        "type": "integer",
                        "description": "æ¯é¡µæ•°æ®é‡ï¼Œé»˜è®¤10æ¡ï¼Œæœ€å¤§50æ¡",
                        "minimum": 1,
                        "maximum": 50,
                        "default": 10
                    },
                    "cursor": {
                        "type": "string",
                        "description": "ç¿»é¡µæ ‡è¯†ï¼Œç”¨äºè·å–ä¸‹ä¸€é¡µæ•°æ®"
                    }
                },
                "required": []
            }
        )
    
    async def execute(self, arguments: Dict[str, Any]) -> List[types.TextContent]:
        """æ‰§è¡Œæ¼æ´æƒ…æŠ¥æŸ¥è¯¢"""
        try:
            # è°ƒç”¨å¾®æ­¥åœ¨çº¿å¨èƒåˆ†æAPI
            result = await self.client.get_vulnerability_info(arguments)
            
            # æ ¼å¼åŒ–ç»“æœ
            formatted_result = self.format_result(result)
            
            return [types.TextContent(
                type="text",
                text=formatted_result
            )]
            
        except Exception as e:
            logger.error(f"æ¼æ´æƒ…æŠ¥æŸ¥è¯¢å¤±è´¥: {e}")
            return [types.TextContent(
                type="text",
                text=f"æŸ¥è¯¢å¤±è´¥: {str(e)}"
            )]
    
    def format_result(self, result: Dict[str, Any]) -> str:
        """æ ¼å¼åŒ–æ¼æ´æƒ…æŠ¥ç»“æœ"""
        
        # ä½¿ç”¨å“åº”å¤„ç†å™¨æ£€æŸ¥çŠ¶æ€

        
        is_success, error_msg = ThreatBookResponseHandler.check_response(result)

        
        if not is_success:

        
            return ThreatBookResponseHandler.format_error_message(result)

        
        

        
        # å¤„ç†éƒ¨åˆ†æˆåŠŸçš„æƒ…å†µ

        
        if error_msg:

        
            # éƒ¨åˆ†æˆåŠŸï¼Œæ˜¾ç¤ºè­¦å‘Šä½†ç»§ç»­å¤„ç†

        
            pass
        
        total_records = result.get("total_records", 0)
        cursor = result.get("cursor", "")
        items = result.get("items", [])
        
        output = [
            f"ğŸ” æ¼æ´æƒ…æŠ¥æŸ¥è¯¢ç»“æœ",
            f"",
            f"ğŸ“Š æ€»è®¡: {total_records} ä¸ªæ¼æ´",
            f"ğŸ“„ å½“å‰é¡µ: {len(items)} ä¸ªæ¼æ´",
        ]
        
        if cursor:
            output.append(f"ğŸ“– ä¸‹ä¸€é¡µæ ‡è¯†: {cursor}")
        
        if not items:
            output.append("")
            output.append("âŒ æœªæ‰¾åˆ°åŒ¹é…çš„æ¼æ´ä¿¡æ¯")
            return "\n".join(output)
        
        output.append("")
        output.append("=" * 50)
        
        for i, item in enumerate(items, 1):
            output.append("")
            output.append(f"ğŸ”¸ æ¼æ´ {i}")
            
            # åŸºæœ¬ä¿¡æ¯
            basic_info = item.get("basic_info", {})
            xve_id = basic_info.get("xve_id", "")
            cve_id = basic_info.get("cve_id", "")
            vuln_name = basic_info.get("vuln_name", "")
            vuln_category = basic_info.get("vuln_category", "")
            publish_time = basic_info.get("publish_time", "")
            
            if xve_id:
                output.append(f"  ğŸ†” XVEç¼–å·: {xve_id}")
            if cve_id:
                output.append(f"  ğŸ†” CVEç¼–å·: {cve_id}")
            if vuln_name:
                output.append(f"  ğŸ“ æ¼æ´åç§°: {vuln_name}")
            if vuln_category:
                output.append(f"  ğŸ“‚ æ¼æ´åˆ†ç±»: {vuln_category}")
            if publish_time:
                output.append(f"  ğŸ“… å‘å¸ƒæ—¶é—´: {publish_time}")
            
            # é£é™©è¯„ä¼°
            evaluation = item.get("evaluation", {})
            x_vpt = evaluation.get("x_vpt", {})
            if x_vpt:
                vpr = x_vpt.get("vpr", "")
                risk_level = x_vpt.get("risk_level", "")
                if vpr:
                    risk_icon = "ğŸ”´" if risk_level == "é«˜é£é™©" else "ğŸŸ¡" if risk_level == "ä¸­é£é™©" else "ğŸŸ¢"
                    output.append(f"  {risk_icon} é£é™©è¯„åˆ†: {vpr}/10.0 ({risk_level})")
            
            # æƒ…æŠ¥ä¿¡æ¯
            intelligence = item.get("intelligence", {})
            if intelligence:
                has_poc = intelligence.get("has_poc_public", False)
                has_kev = intelligence.get("has_kev", False)
                is_highrisk = intelligence.get("is_highrisk", False)
                
                indicators = []
                if has_poc:
                    indicators.append("ğŸ”§ æœ‰å…¬å¼€PoC")
                if has_kev:
                    indicators.append("ğŸš¨ åœ¨é‡åˆ©ç”¨")
                if is_highrisk:
                    indicators.append("âš ï¸ é«˜é£é™©")
                
                if indicators:
                    output.append(f"  ğŸ·ï¸ æ ‡ç­¾: {' | '.join(indicators)}")
            
            # å½±å“èŒƒå›´
            impact = item.get("impact", {})
            if impact:
                affected_vendors = impact.get("affected_vendors_products", [])
                if affected_vendors:
                    vendors = [v.get("vendor", "") for v in affected_vendors[:3]]  # åªæ˜¾ç¤ºå‰3ä¸ª
                    if vendors:
                        vendor_text = ", ".join(filter(None, vendors))
                        if len(affected_vendors) > 3:
                            vendor_text += f" ç­‰{len(affected_vendors)}ä¸ªå‚å•†"
                        output.append(f"  ğŸ¢ å½±å“å‚å•†: {vendor_text}")
            
            # è¯¦æƒ…é“¾æ¥
            link = item.get("link", "")
            if link:
                output.append(f"  ğŸ”— è¯¦æƒ…: {link}")
            
            if i < len(items):  # ä¸æ˜¯æœ€åä¸€ä¸ª
                output.append("")
                output.append("-" * 30)
        
        return "\n".join(output)
